# Telegram Join Request Bot Development Rules

## Project Overview
- Production-ready Telegram bot using grammY with TypeScript
- Automates join request review for private Telegram channels
- Uses Bun as runtime and package manager
- Compatible with Node.js 24.x for Vercel deployment

## Tech Stack Requirements
- Runtime: Bun (primary, compatible with Node.js 24.x APIs)
- Node.js Compatibility: 24.x (latest Vercel-supported version)
- Language: TypeScript (strict mode)
- Framework: grammY latest + @grammyjs/conversations + @grammyjs/session
- Environment: T3 Env (@t3-oss/env-core) with Zod for validation
- Package Manager: Bun (all scripts use `bun` commands)

## Architecture Boundaries
1. Keep handlers separate in `src/handlers/` directory
2. Conversation flow isolated in `src/conversations/` directory
3. Service layer in `src/services/` (authz, reviewCard, state)
4. Type definitions in `src/types.ts`
5. Bot initialization in `src/bot.ts`
6. Entry points: `src/dev.ts` (dev), `src/vercel.ts` (prod), `src/index.ts` (simple)
7. Environment validation in `src/env.ts` using T3 Env

## Coding Standards
- Use TypeScript with strict mode enabled
- All functions must have explicit return types
- Use async/await for async operations
- Error handling required for all API calls
- Session data properly typed through BotContext
- Use Bun-specific APIs where appropriate

## API Integration Rules
- Always validate environment variables at startup using T3 Env
- Use ctx.api for all Telegram API calls
- Handle callback queries with proper error responses
- Update admin messages after approval/decline actions
- Verify admin status in both target chat and admin review chat

## Join Request Workflow
1. Listen for `chat_join_request` event
2. Send DM asking for reason (use conversations plugin)
3. Capture user's text response via conversation
4. Post review card to admin group with buttons
5. Handle `approve_<requestId>` and `decline_<requestId>` callback data
6. Update messages after actions taken
7. Implement idempotency to prevent double-processing

## Environment Variables (Required)
- MODE: dev|prod
- BOT_TOKEN: Telegram bot token from @BotFather
- TARGET_CHAT_ID: Target channel ID (negative number)
- ADMIN_REVIEW_CHAT_ID: Admin group ID (negative number)
- LOG_LEVEL: debug|info|warn|error (default: info)
- Production only: PUBLIC_BASE_URL, WEBHOOK_PATH, WEBHOOK_SECRET_TOKEN
- Optional: REASON_TTL_SECONDS, MAX_REASON_LENGTH, DROP_PENDING_UPDATES_ON_DEV_START

## File Structure Constraints
- No external databases (use in-memory state store with TTL)
- Configuration only through environment variables (validated with T3 Env)
- Modular design - each file has single responsibility
- All TypeScript files in `src/` directory
- Separate entry points for dev and prod modes

## Deployment Modes
- Dev mode: Long polling via `bun run dev` (deletes webhook first)
- Prod mode: Webhook via Vercel serverless function
- Webhook setup: Use `bun run webhook-setup` script

## Performance & Production
- Use error boundaries in all middleware
- Log errors to console (can add logging service later)
- Proper callback query answer (show_alert for errors)
- Don't block operations unnecessarily
- Handle edge cases (missing user data, API failures)
- State store with TTL cleanup every 5 minutes

## Testing & Debugging
- Use `bun run dev` for development with hot reload
- Run `bun run type-check` before deployment
- Ensure all types compile without errors
- Test all workflow paths: approve, decline, invalid input, DM failures
- Verify admin authorization works correctly

## Bun-Specific Notes
- All scripts use `bun` commands (not npm/pnpm)
- TypeScript files run directly with Bun (no compilation step needed for dev)
- Production builds use `tsc` for type checking and compilation
- Use `bunfig.toml` for Bun runtime configuration

## Security Requirements
- Validate webhook secret token in production
- Verify admin status before processing approve/decline actions
- Sanitize user input (reason text length limits)
- Handle API errors gracefully without exposing internals
