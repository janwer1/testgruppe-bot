---
description: Enforce Domain-Driven Design, Hexagonal Architecture, and Separation of Concerns (Session vs Domain)
globs: src/**/*.ts
alwaysApply: true
---

# Architecture & File Structure

This project follows a strict Hexagonal / Domain-Driven Design architecture.

## Core Layers
1.  **Domain (`src/domain/`)**: Pure business logic.
    -   Contains XState machines (`*Machine.ts`) and Entity classes (`*.ts`).
    -   **Rule**: NEVER import from `src/repositories`, `src/services`, or `grammy` here.
    -   **Rule**: The XState machine is the SINGLE SOURCE OF TRUTH for entity state.

2.  **Repositories (`src/repositories/`)**: Persistence adaptation.
    -   **Rule**: Only repositories can access the database/Redis for *Entity* storage.
    -   **Rule**: `save(entity)` must serialize the *entire* domain context.

3.  **Handlers (`src/handlers/`, `src/conversations/`)**: Interface adapters.
    -   **Rule**: Handlers receive `Context` -> Load Entity via Repo -> Dispatch Event -> Save Entity.
    -   **Rule**: NEVER mutate domain state directly. ALWAYS use `entity.actor.send(...)` or helper methods.

4.  **Session Storage**: Managed by Grammy (`ctx.session`).
    -   **Rule**: `ctx.session` is transient (User UI state).
    -   **Rule**: `JoinRequestRepository` is persistent (Business Entity state).
    -   **Rule**: DO NOT mix them. The Session only stores a `requestId` pointer.

## State Management (Critical)
-   **Read**: `ctx.session.requestId` -> `repo.findById(requestId)` -> `DomainEntity`
-   **Write**: `entity.someAction()` -> `repo.save(entity)`

## Testing
-   **Unit Tests**: Colocated with source (`src/domain/JoinRequest.test.ts`).
-   **Runner**: Use `bun:test` syntax (`describe`, `test`, `expect`).
